<!DOCTYPE html>
<html>
<head>
  <title>Chat | Lets Teach</title>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    #chatBox {
      background: #fff;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
    }

    .me, .other {
      margin: 6px 0;
      padding: 6px 8px;
      max-width: 70%;
      border-radius: 6px;
      word-wrap: break-word;
    }

    .me {
      align-self: flex-end;
      background: #d4f8d4;
      text-align: right;
    }

    .other {
      align-self: flex-start;
      background: #e8ecff;
      text-align: left;
    }

    small {
      font-size: 10px;
      color: #666;
    }

    input {
      padding: 8px;
      width: 75%;
    }

    button {
      padding: 8px 14px;
    }
  </style>
</head>

<body>

<h2>Lets Teach Chat (Realtime)</h2>

<input id="senderUid" readonly><br><br>
<input id="receiverUid" readonly><br><br>

<div id="chatBox"></div>

<input id="message" placeholder="Type message">
<button onclick="sendMessage()">Send</button>

<script>
  const BASE_URL = "https://express-hello-world-uh96.onrender.com";

  // ----- URL PARAMS -----
  const params = new URLSearchParams(window.location.search);
  const senderUid = params.get("senderUid");
  const receiverUid = params.get("receiverUid");

  document.getElementById("senderUid").value = senderUid;
  document.getElementById("receiverUid").value = receiverUid;

  // ✅ FINAL ROOM ID (SAME FOR BOTH SIDES)
  const roomId = [senderUid, receiverUid].sort().join("_");
  console.log("ROOM ID:", roomId);

  // ----- SOCKET CONNECT -----
  const socket = io(BASE_URL);

  socket.on("connect", () => {
    console.log("Socket connected:", socket.id);

    // ✅ JOIN ROOM ON CONNECT
    socket.emit("joinRoom", roomId);
  });

  // ----- LOAD CHAT HISTORY -----
  function loadChatHistory() {
    fetch(`${BASE_URL}/api/chat/${senderUid}/${receiverUid}`)
      .then(res => res.json())
      .then(data => {
        const box = document.getElementById("chatBox");
        box.innerHTML = "";

        (data.messages || []).forEach(m => {
          appendMessage(m.senderUid, m.text, m.createdAt);
        });

        box.scrollTop = box.scrollHeight;
      });
  }

  // ----- APPEND MESSAGE -----
  function appendMessage(from, text, timeValue) {
    const box = document.getElementById("chatBox");

    const div = document.createElement("div");
    div.className = from === senderUid ? "me" : "other";

    const time = new Date(timeValue || Date.now()).toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit"
    });

    div.innerHTML = `<small>${time}</small><br>${text}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  // ----- SEND MESSAGE -----
  function sendMessage() {
    const text = document.getElementById("message").value.trim();
    if (!text) return;

    socket.emit("sendMessage", {
      senderUid,
      receiverUid,
      text,
      roomId
    });

    document.getElementById("message").value = "";
  }

  // ----- RECEIVE MESSAGE -----
  socket.on("receiveMessage", (msg) => {
    appendMessage(msg.senderUid, msg.text, msg.createdAt);
  });

  // ----- INIT -----
  loadChatHistory();
</script>

</body>
</html>
