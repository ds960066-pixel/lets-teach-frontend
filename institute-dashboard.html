<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Institute Dashboard | Lets Teach</title>

  <!-- Backend Base URL (ONLY SOURCE) -->
  <script src="./config.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }

    .card {
      background: #fff;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 6px;
    }

    input, select, textarea {
      width: 100%;
      max-width: 520px;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    textarea { min-height: 80px; }

    button {
      padding: 8px 14px;
      background: #2e86de;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 200px;
    }

    .success {
      background: #eafaf1;
      color: #1e7e34;
      border: 1px solid #c3e6cb;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .error {
      background: #fdecea;
      color: #a94442;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<script>
/* ===== AUTH GUARD ===== */
if (!localStorage.uid || localStorage.role !== "institute") {
  window.location.href = "login.html";
}
</script>

<h2>Institute Dashboard</h2>
<button onclick="logout()">Logout</button>

<hr>

<div class="card">
  <h3>Create Job</h3>

  <input id="jobTitle" placeholder="Job Title *">
  <input id="jobCity" placeholder="City *">
  <input id="jobSubject" placeholder="Subject *">

  <select id="jobRole">
    <option value="both">Both</option>
    <option value="part-time">Part-time</option>
    <option value="full-time">Full-time</option>
  </select>

  <input id="jobSalary" placeholder="Salary / Negotiable">
  <textarea id="jobDescription" placeholder="Job description"></textarea>

  <button onclick="postJob()">Post Job</button>
  <div id="jobResult"></div>
</div>

<hr>

<h3>Browse Teachers</h3>
<button onclick="browseTeachers()">Load Teachers</button>
<div id="teachers"></div>

<hr>

<h3>Job Applications</h3>
<button onclick="loadApplications()">View Applications</button>
<div id="applications"></div>

<script>
/* ===== CONTEXT ===== */
const uid = localStorage.getItem("uid");

/* ===== LOGOUT ===== */
window.logout = function () {
  localStorage.clear();
  window.location.href = "login.html";
};

/* ===== POST JOB ===== */
window.postJob = async function () {
  const title = jobTitle.value.trim();
  const city = jobCity.value.trim();
  const subject = jobSubject.value.trim();
  const role = jobRole.value;
  const salary = jobSalary.value.trim();
  const description = jobDescription.value.trim();

  if (!title || !city || !subject) {
    alert("Job Title, City and Subject are required");
    return;
  }

  jobResult.innerHTML = "Posting...";

  try {
    const res = await fetch(`${BASE_URL}/api/job/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        instituteUid: uid,
        title,
        subject,
        city,
        role,
        salary,
        description
      })
    });

    const data = await res.json();

    if (!data.success) {
      jobResult.innerHTML =
        `<div class="error">${data.message || "Job post failed"}</div>`;
      return;
    }

    jobResult.innerHTML =
      `<div class="success">✅ Job posted successfully</div>`;

    jobTitle.value = jobCity.value = jobSubject.value =
      jobSalary.value = jobDescription.value = "";

  } catch {
    jobResult.innerHTML =
      `<div class="error">Server error</div>`;
  }
};

/* ===== BROWSE TEACHERS ===== */
window.browseTeachers = async function () {
  const box = document.getElementById("teachers");
  box.innerHTML = "Loading...";

  try {
    const res = await fetch(`${BASE_URL}/api/teacher/browse`);
    const data = await res.json();

    box.innerHTML = "";

    if (!data.teachers || !data.teachers.length) {
      box.innerHTML = "<p>No teachers found</p>";
      return;
    }

    data.teachers.forEach(t => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML =
        `<b>${t.name}</b> – ${t.subject} (${t.city || ""})`;
      box.appendChild(div);
    });
  } catch {
    box.innerHTML = "<p>Error loading teachers</p>";
  }
};

/* ===== LOAD APPLICATIONS ===== */
window.loadApplications = async function () {
  const box = document.getElementById("applications");
  box.innerHTML = "Loading...";

  try {
    const res = await fetch(
      `${BASE_URL}/api/job/applications/institute/${uid}`
    );
    const data = await res.json();

    box.innerHTML = "";

    if (!data.applications || !data.applications.length) {
      box.innerHTML = "<p>No applications yet</p>";
      return;
    }

    data.applications.forEach(app => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML =
        `<b>Teacher UID:</b> ${app.teacherUid}<br>
         <b>Status:</b> ${app.status}`;
      box.appendChild(div);
    });
  } catch {
    box.innerHTML = "<p>Error loading applications</p>";
  }
};
</script>

</body>
</html>
