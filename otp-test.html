<!DOCTYPE html>
<html>
<head>
  <title>OTP Test | Lets Teach</title>

  <!-- ‚úÖ SINGLE SOURCE OF BACKEND -->
  <script src="./config.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>

<h2>Institute OTP Test</h2>

<input id="phone" placeholder="+91XXXXXXXXXX">
<button onclick="sendOTP()">Send OTP</button>

<br><br>

<input id="otp" placeholder="Enter OTP">
<button onclick="verifyOTP()">Verify OTP</button>

<div id="msg"></div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyB4MyvDI2QZbWTXyJsbnSJ5CehCW_MoEK0",
  authDomain: "lets-teach-37cb9.firebaseapp.com",
  projectId: "lets-teach-37cb9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* ================= INVISIBLE RECAPTCHA ================= */
window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
  document.body,
  { size: "invisible" }
);

let confirmationResult = null;

/* ================= SEND OTP ================= */
async function sendOTP() {
  const phone = document.getElementById("phone").value.trim();
  if (!phone) {
    alert("Enter phone number");
    return;
  }

  try {
    confirmationResult = await auth.signInWithPhoneNumber(
      phone,
      window.recaptchaVerifier
    );

    document.getElementById("msg").innerText = "‚úÖ OTP sent";
  } catch (e) {
    console.error(e);
    document.getElementById("msg").innerText = "‚ùå Failed to send OTP";
  }
}

/* ================= VERIFY OTP ================= */
async function verifyOTP() {
  const otp = document.getElementById("otp").value.trim();
  if (!otp || !confirmationResult) {
    alert("OTP missing");
    return;
  }

  try {
    const result = await confirmationResult.confirm(otp);
    const user = result.user;

    // üîë Firebase ID Token
    const idToken = await user.getIdToken();

    // üî• BACKEND VERIFY (CONFIG BASE_URL)
    const res = await fetch(`${BASE_URL}/api/institute/verify-phone`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        uid: localStorage.getItem("uid"),
        idToken
      })
    });

    const data = await res.json();
    document.getElementById("msg").innerText =
      data.success ? "‚úÖ Phone verified" : JSON.stringify(data);
  } catch (e) {
    console.error(e);
    document.getElementById("msg").innerText = "‚ùå OTP verification failed";
  }
}
</script>

</body>
</html>
